# Minimal image to validate custom node installation only (no models)

ARG BASE_IMAGE=nvidia/cuda:12.6.3-cudnn-runtime-ubuntu24.04
FROM ${BASE_IMAGE} as base

ENV DEBIAN_FRONTEND=noninteractive \
    PIP_PREFER_BINARY=1 \
    PYTHONUNBUFFERED=1

RUN apt-get update && apt-get install -y \
    python3.12 python3.12-venv git wget \
    libgl1 libglib2.0-0 libsm6 libxext6 libxrender1 ffmpeg \
  && ln -sf /usr/bin/python3.12 /usr/bin/python \
  && ln -sf /usr/bin/pip3 /usr/bin/pip \
  && apt-get autoremove -y && apt-get clean -y && rm -rf /var/lib/apt/lists/*

# uv for fast/isolated installs
RUN wget -qO- https://astral.sh/uv/install.sh | sh \
  && ln -s /root/.local/bin/uv /usr/local/bin/uv \
  && uv venv /opt/venv
ENV PATH="/opt/venv/bin:${PATH}"

# comfy-cli + ComfyUI (no models)
RUN uv pip install --no-cache-dir comfy-cli pip setuptools wheel
ARG COMFYUI_VERSION=latest
RUN /usr/bin/yes | comfy --workspace /comfyui install --version "${COMFYUI_VERSION}" --nvidia

WORKDIR /comfyui

# Mandatory install of your required nodes via comfy-node-install helper
COPY scripts/comfy-node-install.sh /usr/local/bin/comfy-node-install
RUN chmod +x /usr/local/bin/comfy-node-install

# Mandatory install of required custom nodes via comfy-cli (using registry names)
# Note: comfy-node-install uses registry names (often lowercase), which we'll rename later
RUN comfy-node-install \
    ComfyLiterals \
    comfyui-detail-daemon \
    comfyui-easy-use \
    comfyui-florence2 \
    comfyui-frame-interpolation \
    ComfyUI-GGUF \
    ComfyUI-GGUF-FantasyTalking \
    comfyui-impact-pack \
    comfyui-kjnodes \
    ComfyUI-LatentSyncWrapper \
    comfyui-logic \
    ComfyUI-Manager \
    comfyui-rmbg \
    comfyui-segment-anything-2 \
    ComfyUI-VibeVoice \
    comfyui-videohelpersuite \
    ComfyUI-WanAnimatePreprocess \
    ComfyUI-WanVideoWrapper \
    ComfyUI_Comfyroll_CustomNodes \
    comfyui_essentials \
    comfyui_layerstyle \
    ComfyUI_LayerStyle_Advance \
    ComfyUI_JPS-Nodes \
    comfyui_ultimatesdupscale \
    comfyui-custom-scripts \
    comfyui-image-selector \
    rgthree-comfy \
    was-node-suite-comfyui \
    cg-use-everywhere \
    comfy-plasma \
    comfyui_controlnet_aux \
    masquerade-nodes-comfyui \
    mikey_nodes

# Install nodes that need special handling (registry names or direct URLs)
RUN cd custom_nodes && \
    # RES4LYF - direct git clone
    git clone https://github.com/ClownsharkBatwing/RES4LYF.git RES4LYF || true && \
    # ComfyUI-TeaCache - registry name: teacache
    comfy-node-install teacache || true && \
    # cg-image-picker - direct GitHub URL (correct owner: chrisgoringe)
    git clone https://github.com/chrisgoringe/cg-image-picker.git cg-image-picker || true && \
    # HavocsCall_Custom_Nodes - registry name: havocscall_custom_nodes
    comfy-node-install havocscall_custom_nodes || true && \
    # DynamicPrompts - direct git clone (correct URL)
    git clone https://github.com/adieyal/comfyui-dynamicprompts.git comfyui-dynamicprompts || true

# Rename directories to match what ComfyUI expects
# comfy-node-install creates directories with registry names (often lowercase), but ComfyUI looks for real repo names
# Rename only if source exists and target doesn't exist (safe to run multiple times)
RUN cd /comfyui/custom_nodes && \
    ([ -d "comfyui-detail-daemon" ] && [ ! -d "ComfyUI-Detail-Daemon" ] && mv comfyui-detail-daemon ComfyUI-Detail-Daemon) || true && \
    ([ -d "comfyui-easy-use" ] && [ ! -d "ComfyUI-Easy-Use" ] && mv comfyui-easy-use ComfyUI-Easy-Use) || true && \
    ([ -d "comfyui-florence2" ] && [ ! -d "ComfyUI-Florence2" ] && mv comfyui-florence2 ComfyUI-Florence2) || true && \
    ([ -d "comfyui-frame-interpolation" ] && [ ! -d "ComfyUI-Frame-Interpolation" ] && mv comfyui-frame-interpolation ComfyUI-Frame-Interpolation) || true && \
    ([ -d "comfyui-impact-pack" ] && [ ! -d "ComfyUI-Impact-Pack" ] && mv comfyui-impact-pack ComfyUI-Impact-Pack) || true && \
    ([ -d "comfyui-kjnodes" ] && [ ! -d "ComfyUI-KJNodes" ] && mv comfyui-kjnodes ComfyUI-KJNodes) || true && \
    ([ -d "comfyui-logic" ] && [ ! -d "ComfyUI-Logic" ] && mv comfyui-logic ComfyUI-Logic) || true && \
    ([ -d "comfyui-rmbg" ] && [ ! -d "ComfyUI-RMBG" ] && mv comfyui-rmbg ComfyUI-RMBG) || true && \
    ([ -d "comfyui-segment-anything-2" ] && [ ! -d "ComfyUI-segment-anything-2" ] && mv comfyui-segment-anything-2 ComfyUI-segment-anything-2) || true && \
    ([ -d "comfyui-videohelpersuite" ] && [ ! -d "ComfyUI-VideoHelperSuite" ] && mv comfyui-videohelpersuite ComfyUI-VideoHelperSuite) || true && \
    ([ -d "comfyui_layerstyle" ] && [ ! -d "ComfyUI_LayerStyle" ] && mv comfyui_layerstyle ComfyUI_LayerStyle) || true && \
    ([ -d "comfyui_ultimatesdupscale" ] && [ ! -d "ComfyUI_UltimateSDUpscale" ] && mv comfyui_ultimatesdupscale ComfyUI_UltimateSDUpscale) || true && \
    ([ -d "comfyui_essentials" ] && [ ! -d "ComfyUI_essentials" ] && mv comfyui_essentials ComfyUI_essentials) || true && \
    ([ -d "havocscall_custom_nodes" ] && [ ! -d "comfyui_HavocsCall_Custom_Nodes" ] && mv havocscall_custom_nodes comfyui_HavocsCall_Custom_Nodes) || true && \
    ([ -d "teacache" ] && [ ! -d "ComfyUI-TeaCache" ] && mv teacache ComfyUI-TeaCache) || true

# Verify: ensure each node directory exists and has at least one .py file
RUN set -euo pipefail; \
  echo "Verifying custom nodes..."; \
  missing=0; \
  for d in custom_nodes/*; do \
    [ -d "$d" ] || continue; \
    pycount=$(find "$d" -type f -name "*.py" | wc -l || true); \
    if [ "${pycount}" = "0" ]; then \
      echo "ERROR: Node '$d' has no Python files." >&2; \
      missing=1; \
    fi; \
  done; \
  if [ "$missing" != "0" ]; then \
    echo "At least one node appears incomplete." >&2; exit 1; \
  fi; \
  echo "All custom nodes present.";

# Final minimal layer
CMD ["bash", "-lc", "ls -1 custom_nodes | sed -n '1,200p' && echo 'Nodes verified.' && sleep 3600"]


