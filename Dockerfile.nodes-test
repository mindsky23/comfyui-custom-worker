# Minimal image to validate custom node installation only (no models)

ARG BASE_IMAGE=nvidia/cuda:12.6.3-cudnn-runtime-ubuntu24.04
FROM ${BASE_IMAGE} as base

ENV DEBIAN_FRONTEND=noninteractive \
    PIP_PREFER_BINARY=1 \
    PYTHONUNBUFFERED=1

RUN apt-get update && apt-get install -y \
    python3.12 python3.12-venv git wget \
    libgl1 libglib2.0-0 libsm6 libxext6 libxrender1 ffmpeg \
  && ln -sf /usr/bin/python3.12 /usr/bin/python \
  && ln -sf /usr/bin/pip3 /usr/bin/pip \
  && apt-get autoremove -y && apt-get clean -y && rm -rf /var/lib/apt/lists/*

# uv for fast/isolated installs
RUN wget -qO- https://astral.sh/uv/install.sh | sh \
  && ln -s /root/.local/bin/uv /usr/local/bin/uv \
  && uv venv /opt/venv
ENV PATH="/opt/venv/bin:${PATH}"

# comfy-cli + ComfyUI (no models)
RUN uv pip install --no-cache-dir comfy-cli pip setuptools wheel
ARG COMFYUI_VERSION=latest
RUN /usr/bin/yes | comfy --workspace /comfyui install --version "${COMFYUI_VERSION}" --nvidia

WORKDIR /comfyui

# Mandatory install of your required nodes via comfy-node-install helper
COPY scripts/comfy-node-install.sh /usr/local/bin/comfy-node-install
RUN chmod +x /usr/local/bin/comfy-node-install

RUN comfy-node-install \
    ComfyLiterals \
    ComfyUI-Detail-Daemon \
    ComfyUI-Easy-Use \
    comfyui-frame-interpolation \
    ComfyUI-GGUF \
    ComfyUI-GGUF-FantasyTalking \
    ComfyUI-Impact-Pack \
    comfyui-kjnodes \
    ComfyUI-LatentSyncWrapper \
    ComfyUI-Logic \
    ComfyUI-Manager \
    ComfyUI-RMBG \
    ComfyUI-segment-anything-2 \
    ComfyUI-VibeVoice \
    ComfyUI-VideoHelperSuite \
    ComfyUI-WanAnimatePreprocess \
    ComfyUI-WanVideoWrapper \
    ComfyUI_Comfyroll_CustomNodes \
    comfyui_essentials \
    ComfyUI_LayerStyle \
    ComfyUI_LayerStyle_Advance \
    ComfyUI_JPS-Nodes \
    ComfyUI_UltimateSDUpscale \
    comfyui-custom-scripts \
    comfyui-image-selector \
    rgthree-comfy \
    was-node-suite-comfyui \
    cg-use-everywhere \
    comfy-plasma \
    comfyui_controlnet_aux \
    masquerade-nodes-comfyui \
    mikey_nodes

# Install nodes that need special handling (registry names or direct URLs)
RUN cd custom_nodes && \
    # RES4LYF - direct git clone
    git clone https://github.com/ClownsharkBatwing/RES4LYF.git RES4LYF || true && \
    # ComfyUI-TeaCache - registry name: teacache
    comfy-node-install teacache || true && \
    # cg-image-picker - direct GitHub URL (correct owner: chrisgoringe)
    git clone https://github.com/chrisgoringe/cg-image-picker.git cg-image-picker || true && \
    # HavocsCall_Custom_Nodes - registry name: havocscall_custom_nodes
    comfy-node-install havocscall_custom_nodes || true && \
    # DynamicPrompts - direct git clone (correct URL)
    git clone https://github.com/adieyal/comfyui-dynamicprompts.git comfyui-dynamicprompts || true

# Verify: ensure each node directory exists and has at least one .py file
RUN set -euo pipefail; \
  echo "Verifying custom nodes..."; \
  missing=0; \
  for d in custom_nodes/*; do \
    [ -d "$d" ] || continue; \
    pycount=$(find "$d" -type f -name "*.py" | wc -l || true); \
    if [ "${pycount}" = "0" ]; then \
      echo "ERROR: Node '$d' has no Python files." >&2; \
      missing=1; \
    fi; \
  done; \
  if [ "$missing" != "0" ]; then \
    echo "At least one node appears incomplete." >&2; exit 1; \
  fi; \
  echo "All custom nodes present.";

# Final minimal layer
CMD ["bash", "-lc", "ls -1 custom_nodes | sed -n '1,200p' && echo 'Nodes verified.' && sleep 3600"]


